<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    <base href="https://quxiaowei.github.io">
    <title>☐☐☐☐</title>
    <link rel="canonical" href="https://quxiaowei.github.io/post/abap_call_restful_webservice/">
    
<link rel="stylesheet" href="https://quxiaowei.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="https://quxiaowei.github.io/css/styles.css">
<link rel="stylesheet" href="https://quxiaowei.github.io/css/post.css">


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="./script/site.js"></script>
</head>

<body>
    <div class="column container">
<header class="header">
    <a href="/" class="title">☐☐☐☐</a>
    
</header>


<section id="main" class="col-md-10">
    <header class="post-header">
      <p class="post-title">ABAP 调用 RESTful Web Service </p>
      <p class="post-meta">2016年7月19日</p>
    </header>
    <article itemprop="articleBody" id="content">
       <blockquote>
<p>哎！一片干的掉渣的文章。</p>
</blockquote>
<h4 id="关于rest">关于REST</h4>
<p>REST 是基于 HTTP 的 Web Service 架构，URL 表示资源，HTTP method: GET, POST, DELETE 等等，表示发送，收取，删除等动作。我们是从第三方接收资源，所以用 GET。</p>
<blockquote>
<p>SOAP 是另一种基于 HTTP 的 Web Service 协议，不在本文范围内。</p>
</blockquote>
<p>以 <code>http://example/credit/20160516/0000001880/1380</code> 为例，其中 <code>20160516</code> 代表日期，<code>0000001880</code> 代表客户，<code>1380</code> 代表公司，这些作为 Web Service 的参数发给接口。</p>
<h4 id="http调用">HTTP调用</h4>
<p>ABAP 有许多发送 HTTP GET 请求的方法。我用的是函数: <code>HTTP_GET</code>。注意设定超时限制，防止网络不通时程序卡死。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">DATA</span>: status(<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">TYPE </span>c ,
      url <span style="color:#66d9ef">TYPE </span>c <span style="color:#66d9ef">LENGTH</span> <span style="color:#ae81ff">200</span>,
      error <span style="color:#66d9ef">TYPE </span>string.

<span style="color:#66d9ef">DATA</span>: response <span style="color:#66d9ef">TYPE TABLE OF</span> xtext100 <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">HEADER LINE</span>, <span style="color:#75715e">&#34; 返回内容
</span><span style="color:#75715e"></span>      <span style="color:#75715e">&#34; HTTP header
</span><span style="color:#75715e"></span>      response_headers <span style="color:#66d9ef">TYPE TABLE OF</span> text100 <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">HEADER LINE</span>.

url <span style="color:#f92672">=</span> |<span style="color:#e6db74">http://example/credit/</span>{ p_datum }<span style="color:#e6db74">/</span>{ p_customer }<span style="color:#e6db74">/</span>{ p_company }| .

<span style="color:#66d9ef">CALL FUNCTION</span> <span style="color:#e6db74">&#39;HTTP_GET&#39;</span>
  <span style="color:#66d9ef">EXPORTING</span>
    absolute_uri          <span style="color:#f92672">=</span> url    <span style="color:#75715e">&#34; url
</span><span style="color:#75715e"></span>    timeout               <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>      <span style="color:#75715e">&#34; 超时
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">IMPORTING</span>
    status_code           <span style="color:#f92672">=</span> status  <span style="color:#75715e">&#34; 200 404等网页状态
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">TABLES</span>
    response_entity_body  <span style="color:#f92672">=</span> response
    response_headers      <span style="color:#f92672">=</span> response_headers
  <span style="color:#66d9ef">EXCEPTIONS</span>
    connect_failed        <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    timeout               <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
    internal_error        <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
    tcpip_error           <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
    data_error            <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
    system_failure        <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>
    communication_failure <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
    <span style="color:#66d9ef">OTHERS</span>                <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>.

<span style="color:#66d9ef">IF</span> sy<span style="color:#f92672">-</span>subrc <span style="color:#f92672">EQ</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">AND</span> status(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">EQ</span> <span style="color:#e6db74">&#39;2&#39;</span>.
  <span style="color:#75715e">&#34; 成功
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ELSE</span>.
  <span style="color:#75715e">&#34; 失败
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ENDIF</span>.
</code></pre></div><h4 id="decode">Decode</h4>
<p>返回内容的编码可能与 Sap 不兼容，那么需要转码。具体编码信息在 HTTP 头里。
以常见的 UTF-8 为例。</p>
<p><em>Decode 代码</em> ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">DATA</span> conv <span style="color:#66d9ef">TYPE REF TO</span> cl_ABAP_conv_in_ce.
<span style="color:#66d9ef">DATA</span> buffer <span style="color:#66d9ef">TYPE </span>xstring.
<span style="color:#66d9ef">DATA</span> v_text <span style="color:#66d9ef">TYPE </span>string.<span style="color:#75715e">&#34;(100) TYPE c.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">DATA</span> v_text_t <span style="color:#66d9ef">TYPE </span>string.<span style="color:#75715e">&#34;(100) TYPE c.
</span><span style="color:#75715e"></span>
conv <span style="color:#f92672">=</span> cl_ABAP_conv_in_ce<span style="color:#f92672">=&gt;</span><span style="color:#a6e22e">create</span>( encoding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;UTF-8&#39;</span> ).
<span style="color:#66d9ef">LOOP AT </span>response.
  buffer <span style="color:#f92672">=</span> response.
  <span style="color:#66d9ef">TRY</span>.
      conv<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">convert</span>(
            <span style="color:#66d9ef">EXPORTING</span> input <span style="color:#f92672">=</span> buffer
            <span style="color:#66d9ef">IMPORTING</span> <span style="color:#66d9ef">data</span> <span style="color:#f92672">=</span> v_text_t ).
      <span style="color:#66d9ef">CONCATENATE</span> v_text v_text_t <span style="color:#66d9ef">INTO</span> v_text.
    <span style="color:#66d9ef">CATCH</span> cx_sy_conversion_codepage
          cx_sy_codepage_converter_init
          cx_parameter_invalid_type.
      p_subrc <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>.
      p_message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;转码失败！&#39;</span>.
      <span style="color:#66d9ef">RETURN</span>.
  <span style="color:#66d9ef">ENDTRY</span>.
<span style="color:#66d9ef">ENDLOOP</span>.
</code></pre></div><h4 id="json映射到abap">JSON映射到ABAP</h4>
<p>常见的 Web Service 返回格式有 XML 和 JSON 两种。处理 XML 的方法和 JSON 大致相同，只是 “转换”的写法不同。以 JSON 为例：</p>
<p><em>JSON 示例</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[
  {
    <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.0122</span>,
    <span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>
    },
  {
    <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2.01</span>,
    <span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>
  }
]
</code></pre></div><p>这是一个包含 2 个对象的数组（<code>[]</code>表示数组），每个对象（<code>{}</code>表示对象）中有三个字段： <code>result</code>, <code>errorCode</code>, <code>errorMessage</code>。<code>result</code>是数字型的（注意没有引号包围），其他均为字符串。</p>
<p><em>ABAP 代码</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">TYPES</span>: <span style="color:#66d9ef">BEGIN OF</span> ty_result,
        <span style="color:#66d9ef">result TYPE </span>string,
        errorcode <span style="color:#66d9ef">TYPE </span>string,
        errormessage <span style="color:#66d9ef">TYPE </span>string,
       <span style="color:#66d9ef">END OF</span> ty_result.
<span style="color:#66d9ef">DATA</span> it_result <span style="color:#66d9ef">TYPE TABLE OF</span> ty_result.

<span style="color:#66d9ef">TRY</span>
    <span style="color:#66d9ef">CALL TRANSFORMATION</span> z_test_json1 <span style="color:#66d9ef">SOURCE XML</span> v_text
                                     <span style="color:#66d9ef">RESULT </span>out <span style="color:#f92672">=</span> it_result.
  <span style="color:#66d9ef">CATCH</span> cx_st_error cx_xslt_exception cx_transformation_error.
    <span style="color:#75715e">&#34; 解析JSON失败
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ENDTRY</span>.
</code></pre></div><p><code>z_test_json1</code> 是自定义的 “转换”，将 JSON 中的数据映射到 ABAP 内表或工作区里，因为过程涉及类型转换，所以需要 <code>try catch</code> 来捕捉异常。“转换”完成后，JSON 中的数据会回填到 <code>it_result</code> 内表中，整个解析的流程也就完成了。</p>
<h4 id="转换的写法">“转换”的写法</h4>
<ol>
<li>
<p>创建“转换” <img src="/img/transform1.png" alt="创建“转换”"></p>
</li>
<li>
<p>“转换类型”选择“简单转换”</p>
</li>
<li>
<p>“转换”示例</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-XML" data-lang="XML"><span style="color:#75715e">&lt;?sap.transform simple?&gt;</span>
<span style="color:#f92672">&lt;tt:transform</span> <span style="color:#a6e22e">xmlns:tt=</span><span style="color:#e6db74">&#34;http://www.sap.com/transformation-templates&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;tt:root</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;OUT&#34;</span><span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;tt:template&gt;</span>
    <span style="color:#f92672">&lt;array&gt;</span>
      <span style="color:#f92672">&lt;tt:loop</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;OUT&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;object&gt;</span>
          <span style="color:#f92672">&lt;num</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">&gt;</span>
            <span style="color:#f92672">&lt;tt:value</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;$ref.RESULT&#34;</span><span style="color:#f92672">/&gt;</span>
          <span style="color:#f92672">&lt;/num&gt;</span>
          <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">&gt;</span>
            <span style="color:#f92672">&lt;tt:value</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;$ref.ERRORCODE&#34;</span><span style="color:#f92672">/&gt;</span>
          <span style="color:#f92672">&lt;/str&gt;</span>
          <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">&gt;</span>
            <span style="color:#f92672">&lt;tt:value</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;$ref.ERRORMESSAGE&#34;</span><span style="color:#f92672">/&gt;</span>
          <span style="color:#f92672">&lt;/str&gt;</span>
        <span style="color:#f92672">&lt;/object&gt;</span>
      <span style="color:#f92672">&lt;/tt:loop&gt;</span>
    <span style="color:#f92672">&lt;/array&gt;</span>
  <span style="color:#f92672">&lt;/tt:template&gt;</span>
<span style="color:#f92672">&lt;/tt:transform&gt;</span>
</code></pre></div><ul>
<li>
<p><code>&lt;array&gt;</code> 代表数组，与 JSON 的 <code>[]</code>对应。</p>
</li>
<li>
<p><code>&lt;object&gt;</code> 代表对象，与 JSON 的 <code>{}</code>对应。</p>
</li>
<li>
<p><code>&lt;tt:loop&gt;</code> 循环处理多个对象，“转换” 把数据依次 append 到内表中，对于单条数据不需要使用<code>&lt;tt:loop&gt;</code>。</p>
</li>
<li>
<p><code>&lt;num&gt;</code> <code>&lt;str&gt;</code> 代表数字、字符串，要与 JSON 的类型对应，否则会报错，如果有非法字符也会报异常，转换过程需要用<code>try catch</code>来捕捉异常。</p>
</li>
<li>
<p><code>&lt;tt:value&gt;</code> <code>name</code> 属性与表字段名对应，转换程序会自动将值放到内表或工作区的字段中。</p>
</li>
<li>
<p><code>&lt;tt:root&gt;</code> <code>name</code> 为“转换”结果（RESULT）的形参名（本例为 out）。</p>
</li>
</ul>
<blockquote>
<p>JSON 对象内的字段不要求和 ABAP 类型字段顺序一致</p>
</blockquote>
<h4 id="abap-to-json">ABAP to JSON</h4>
<p>我们已经能够将 JSON 映射到 ABAP 里，下面我们试着将 ABAP 再转回 JSON。首先，我们将上面的 <code>call transformation</code> 中的 <code>source</code> 和 <code>result</code> 对调，反向使用“转换”。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">CALL TRANSFORMATION</span> z_test_json1 <span style="color:#66d9ef">SOURCE </span>out <span style="color:#f92672">=</span> it_result
                                 <span style="color:#66d9ef">RESULT XML</span> <span style="color:#f92672">=</span> v_text.
</code></pre></div><p><strong>v_text</strong> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-XML" data-lang="XML"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-16&#34;?&gt;</span>
<span style="color:#f92672">&lt;array&gt;</span>
  <span style="color:#f92672">&lt;object&gt;</span>
    <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">&gt;</span>0.01<span style="color:#f92672">&lt;/str&gt;</span>
    <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">&gt;</span>0<span style="color:#f92672">&lt;/str&gt;</span>
    <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;/str&gt;</span>
  <span style="color:#f92672">&lt;/object&gt;</span>
  <span style="color:#f92672">&lt;object&gt;</span>
    <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">&gt;</span>2.01<span style="color:#f92672">&lt;/str&gt;</span>
    <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">&gt;</span>0<span style="color:#f92672">&lt;/str&gt;</span>
    <span style="color:#f92672">&lt;str</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;/str&gt;</span>
  <span style="color:#f92672">&lt;/object&gt;</span>
<span style="color:#f92672">&lt;/array&gt;</span>
</code></pre></div><p>我们发现 <code>v_text</code> 里的是 XML，如果需要的是 XML 格式，那么任务已经完成。为了得到 JSON，我们继续做如下修改：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">DATA</span> json_writer <span style="color:#66d9ef">TYPE REF TO</span> cl_sxml_string_writer.
json_writer <span style="color:#f92672">=</span> cl_sxml_string_writer<span style="color:#f92672">=&gt;</span><span style="color:#a6e22e">create</span>( type <span style="color:#f92672">=</span> if_sxml<span style="color:#f92672">=&gt;</span>co_xt_json ).
<span style="color:#66d9ef">CALL TRANSFORMATION</span> z_test_json1 <span style="color:#66d9ef">SOURCE </span>out <span style="color:#f92672">=</span> it_result
                                 <span style="color:#66d9ef">RESULT XML</span> json_writer. <span style="color:#75715e">&#34; json_writer.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">&#34; Get json-String from writer
</span><span style="color:#75715e"></span><span style="color:#66d9ef">DATA</span> json <span style="color:#66d9ef">TYPE </span>xstring.
json <span style="color:#f92672">=</span> json_writer<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_output</span>( ).
v_text <span style="color:#f92672">=</span> cl_ABAP_codepage<span style="color:#f92672">=&gt;</span><span style="color:#a6e22e">convert_from</span>( json ).
</code></pre></div><p>我们用类型为 co_xt_json 的 sxml_string_writer，将 XML 输出为 JSON 格式。 <strong>注意</strong> <code>get_output()</code> 输出的是字节码，要用 <code>cl_abap_codepage=&gt;convert_from( )</code> 转换成文本。</p>
<p><strong>v_text</strong> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[
  {
    <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.01</span>,
    <span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>
    },
  {
    <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2.01</span>,
    <span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>
  }
]
</code></pre></div><p>- 后篇 <a href="post/abap_provide_restful_ws/">&ldquo;ABAP 发布 RESTful Web Service&rdquo;</a></p>

 <p>『 終 』</p>

    </article>
</section>

<footer class="bottom-footer">
  
</footer>

<script>
  renderMathInElement(document.getElementById('main'));
</script>

</div>


<a href="javascript:" id="return-to-top"><i class="icon-chevron-up"></i></a>

<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

</body>

</html>
