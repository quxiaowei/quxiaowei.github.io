<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    <base href="https://quxiaowei.github.io">
    <title>A CodeSmith</title>
    <link rel="canonical" href="https://quxiaowei.github.io/post/abap_call_restful_webservice/">
    
<link rel="stylesheet" href="https://quxiaowei.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="https://quxiaowei.github.io/css/styles.css">
<link rel="stylesheet" href="https://quxiaowei.github.io/css/post.css">


<link href="https://quxiaowei.github.io/index.xml" rel="alternate" type="application/rss+xml" title="A CodeSmith" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="./script/site.js"></script>
</head>

<body>
    <div class="column container">
<header class="header">
    <a href="/" class="title">A CodeSmith</a>
    
    <span class="menu-bar"><a href="/album/">ğŸ§</a></span>
</header>

<section id="main" class="col-md-10">
    <header class="post-header">
      <p class="post-title">ABAP è°ƒç”¨ RESTful Web Service </p>
      <p class="post-meta">2016å¹´7æœˆ19æ—¥</p>
    </header>
    <article itemprop="articleBody" id="content">
       <blockquote>
<p>å“ï¼ä¸€ç‰‡å¹²çš„æ‰æ¸£çš„æ–‡ç« ã€‚</p>
</blockquote>
<h4 id="å…³äºrest">å…³äºREST</h4>
<p>REST æ˜¯åŸºäº HTTP çš„ Web Service æ¶æ„ï¼ŒURL è¡¨ç¤ºèµ„æºï¼ŒHTTP method: GET, POST, DELETE ç­‰ç­‰ï¼Œè¡¨ç¤ºå‘é€ï¼Œæ”¶å–ï¼Œåˆ é™¤ç­‰åŠ¨ä½œã€‚æˆ‘ä»¬æ˜¯ä»ç¬¬ä¸‰æ–¹æ¥æ”¶èµ„æºï¼Œæ‰€ä»¥ç”¨ GETã€‚</p>
<blockquote>
<p>SOAP æ˜¯å¦ä¸€ç§åŸºäº HTTP çš„ Web Service åè®®ï¼Œä¸åœ¨æœ¬æ–‡èŒƒå›´å†…ã€‚</p>
</blockquote>
<p>ä»¥ <code>http://example/credit/20160516/0000001880/1380</code> ä¸ºä¾‹ï¼Œå…¶ä¸­ <code>20160516</code> ä»£è¡¨æ—¥æœŸï¼Œ<code>0000001880</code> ä»£è¡¨å®¢æˆ·ï¼Œ<code>1380</code> ä»£è¡¨å…¬å¸ï¼Œè¿™äº›ä½œä¸º Web Service çš„å‚æ•°å‘ç»™æ¥å£ã€‚</p>
<h4 id="httpè°ƒç”¨">HTTPè°ƒç”¨</h4>
<p>ABAP æœ‰è®¸å¤šå‘é€ HTTP GET è¯·æ±‚çš„æ–¹æ³•ã€‚æˆ‘ç”¨çš„æ˜¯å‡½æ•°: <code>HTTP_GET</code>ã€‚æ³¨æ„è®¾å®šè¶…æ—¶é™åˆ¶ï¼Œé˜²æ­¢ç½‘ç»œä¸é€šæ—¶ç¨‹åºå¡æ­»ã€‚</p>
<pre><code>DATA: status(3) TYPE c ,
      url TYPE c LENGTH 200,
      error TYPE string.

DATA: response TYPE TABLE OF xtext100 WITH HEADER LINE, &quot; è¿”å›å†…å®¹
      &quot; HTTP header
      response_headers TYPE TABLE OF text100 WITH HEADER LINE.

url = |http://example/credit/{ p_datum }/{ p_customer }/{ p_company }| .

CALL FUNCTION 'HTTP_GET'
  EXPORTING
    absolute_uri          = url    &quot; url
    timeout               = 1      &quot; è¶…æ—¶
  IMPORTING
    status_code           = status  &quot; 200 404ç­‰ç½‘é¡µçŠ¶æ€
  TABLES
    response_entity_body  = response
    response_headers      = response_headers
  EXCEPTIONS
    connect_failed        = 1
    timeout               = 2
    internal_error        = 3
    tcpip_error           = 4
    data_error            = 5
    system_failure        = 6
    communication_failure = 7
    OTHERS                = 8.

IF sy-subrc EQ 0 AND status(1) EQ '2'.
  &quot; æˆåŠŸ
ELSE.
  &quot; å¤±è´¥
ENDIF.
</code></pre><h4 id="decode">Decode</h4>
<p>è¿”å›å†…å®¹çš„ç¼–ç å¯èƒ½ä¸ Sap ä¸å…¼å®¹ï¼Œé‚£ä¹ˆéœ€è¦è½¬ç ã€‚å…·ä½“ç¼–ç ä¿¡æ¯åœ¨ HTTP å¤´é‡Œã€‚
ä»¥å¸¸è§çš„ UTF-8 ä¸ºä¾‹ã€‚</p>
<p><em>Decode ä»£ç </em> ï¼š</p>
<pre><code>DATA conv TYPE REF TO cl_ABAP_conv_in_ce.
DATA buffer TYPE xstring.
DATA v_text TYPE string.&quot;(100) TYPE c.
DATA v_text_t TYPE string.&quot;(100) TYPE c.

conv = cl_ABAP_conv_in_ce=&gt;create( encoding = 'UTF-8' ).
LOOP AT response.
  buffer = response.
  TRY.
      conv-&gt;convert(
            EXPORTING input = buffer
            IMPORTING data = v_text_t ).
      CONCATENATE v_text v_text_t INTO v_text.
    CATCH cx_sy_conversion_codepage
          cx_sy_codepage_converter_init
          cx_parameter_invalid_type.
      p_subrc = 4.
      p_message = 'è½¬ç å¤±è´¥ï¼'.
      RETURN.
  ENDTRY.
ENDLOOP.
</code></pre><h4 id="jsonæ˜ å°„åˆ°abap">JSONæ˜ å°„åˆ°ABAP</h4>
<p>å¸¸è§çš„ Web Service è¿”å›æ ¼å¼æœ‰ XML å’Œ JSON ä¸¤ç§ã€‚å¤„ç† XML çš„æ–¹æ³•å’Œ JSON å¤§è‡´ç›¸åŒï¼Œåªæ˜¯ â€œè½¬æ¢â€çš„å†™æ³•ä¸åŒã€‚ä»¥ JSON ä¸ºä¾‹ï¼š</p>
<p><em>JSON ç¤ºä¾‹</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[
  {
    <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.0122</span>,
    <span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>
    },
  {
    <span style="color:#e6db74">&#34;result&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2.01</span>,
    <span style="color:#e6db74">&#34;errorCode&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;errorMessage&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>
  }
]
</code></pre></div><p>è¿™æ˜¯ä¸€ä¸ªåŒ…å« 2 ä¸ªå¯¹è±¡çš„æ•°ç»„ï¼ˆ<code>[]</code>è¡¨ç¤ºæ•°ç»„ï¼‰ï¼Œæ¯ä¸ªå¯¹è±¡ï¼ˆ<code>{}</code>è¡¨ç¤ºå¯¹è±¡ï¼‰ä¸­æœ‰ä¸‰ä¸ªå­—æ®µï¼š <code>result</code>, <code>errorCode</code>, <code>errorMessage</code>ã€‚<code>result</code>æ˜¯æ•°å­—å‹çš„ï¼ˆæ³¨æ„æ²¡æœ‰å¼•å·åŒ…å›´ï¼‰ï¼Œå…¶ä»–å‡ä¸ºå­—ç¬¦ä¸²ã€‚</p>
<p><em>ABAP ä»£ç </em></p>
<pre><code>TYPES: BEGIN OF ty_result,
        result TYPE string,
        errorcode TYPE string,
        errormessage TYPE string,
       END OF ty_result.
DATA it_result TYPE TABLE OF ty_result.

TRY
    CALL TRANSFORMATION z_test_json1 SOURCE XML v_text
                                     RESULT out = it_result.
  CATCH cx_st_error cx_xslt_exception cx_transformation_error.
    &quot; è§£æJSONå¤±è´¥
ENDTRY.
</code></pre><p><code>z_test_json1</code> æ˜¯è‡ªå®šä¹‰çš„ â€œè½¬æ¢â€ï¼Œå°† JSON ä¸­çš„æ•°æ®æ˜ å°„åˆ° ABAP å†…è¡¨æˆ–å·¥ä½œåŒºé‡Œï¼Œå› ä¸ºè¿‡ç¨‹æ¶‰åŠç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥éœ€è¦ <code>try catch</code> æ¥æ•æ‰å¼‚å¸¸ã€‚â€œè½¬æ¢â€å®Œæˆåï¼ŒJSON ä¸­çš„æ•°æ®ä¼šå›å¡«åˆ° <code>it_result</code> å†…è¡¨ä¸­ï¼Œæ•´ä¸ªè§£æçš„æµç¨‹ä¹Ÿå°±å®Œæˆäº†ã€‚</p>
<h4 id="è½¬æ¢çš„å†™æ³•">â€œè½¬æ¢â€çš„å†™æ³•</h4>
<ol>
<li>
<p>åˆ›å»ºâ€œè½¬æ¢â€ <img src="/img/transform1.png" alt="åˆ›å»ºâ€œè½¬æ¢â€"></p>
</li>
<li>
<p>â€œè½¬æ¢ç±»å‹â€é€‰æ‹©â€œç®€å•è½¬æ¢â€</p>
</li>
<li>
<p>â€œè½¬æ¢â€ç¤ºä¾‹</p>
</li>
</ol>
<pre><code>&lt;?sap.transform simple?&gt;
&lt;tt:transform xmlns:tt=&quot;http://www.sap.com/transformation-templates&quot;&gt;
  &lt;tt:root name=&quot;OUT&quot;/&gt;
  &lt;tt:template&gt;
    &lt;array&gt;
      &lt;tt:loop ref=&quot;OUT&quot;&gt;
        &lt;object&gt;
          &lt;num name=&quot;result&quot;&gt;
            &lt;tt:value ref=&quot;$ref.RESULT&quot;/&gt;
          &lt;/num&gt;
          &lt;str name=&quot;errorCode&quot;&gt;
            &lt;tt:value ref=&quot;$ref.ERRORCODE&quot;/&gt;
          &lt;/str&gt;
          &lt;str name=&quot;errorMessage&quot;&gt;
            &lt;tt:value ref=&quot;$ref.ERRORMESSAGE&quot;/&gt;
          &lt;/str&gt;
        &lt;/object&gt;
      &lt;/tt:loop&gt;
    &lt;/array&gt;
  &lt;/tt:template&gt;
&lt;/tt:transform&gt;
</code></pre><ul>
<li>
<p><code>&lt;array&gt;</code> ä»£è¡¨æ•°ç»„ï¼Œä¸ JSON çš„ <code>[]</code>å¯¹åº”ã€‚</p>
</li>
<li>
<p><code>&lt;object&gt;</code> ä»£è¡¨å¯¹è±¡ï¼Œä¸ JSON çš„ <code>{}</code>å¯¹åº”ã€‚</p>
</li>
<li>
<p><code>&lt;tt:loop&gt;</code> å¾ªç¯å¤„ç†å¤šä¸ªå¯¹è±¡ï¼Œâ€œè½¬æ¢â€ æŠŠæ•°æ®ä¾æ¬¡ append åˆ°å†…è¡¨ä¸­ï¼Œå¯¹äºå•æ¡æ•°æ®ä¸éœ€è¦ä½¿ç”¨<code>&lt;tt:loop&gt;</code>ã€‚</p>
</li>
<li>
<p><code>&lt;num&gt;</code> <code>&lt;str&gt;</code> ä»£è¡¨æ•°å­—ã€å­—ç¬¦ä¸²ï¼Œè¦ä¸ JSON çš„ç±»å‹å¯¹åº”ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå¦‚æœæœ‰éæ³•å­—ç¬¦ä¹Ÿä¼šæŠ¥å¼‚å¸¸ï¼Œè½¬æ¢è¿‡ç¨‹éœ€è¦ç”¨<code>try catch</code>æ¥æ•æ‰å¼‚å¸¸ã€‚</p>
</li>
<li>
<p><code>&lt;tt:value&gt;</code> <code>name</code> å±æ€§ä¸è¡¨å­—æ®µåå¯¹åº”ï¼Œè½¬æ¢ç¨‹åºä¼šè‡ªåŠ¨å°†å€¼æ”¾åˆ°å†…è¡¨æˆ–å·¥ä½œåŒºçš„å­—æ®µä¸­ã€‚</p>
</li>
<li>
<p><code>&lt;tt:root&gt;</code> <code>name</code> ä¸ºâ€œè½¬æ¢â€ç»“æœï¼ˆRESULTï¼‰çš„å½¢å‚åï¼ˆæœ¬ä¾‹ä¸º outï¼‰ã€‚</p>
</li>
</ul>
<blockquote>
<p>JSON å¯¹è±¡å†…çš„å­—æ®µä¸è¦æ±‚å’Œ ABAP ç±»å‹å­—æ®µé¡ºåºä¸€è‡´</p>
</blockquote>
<h4 id="abap-to-json">ABAP to JSON</h4>
<p>æˆ‘ä»¬å·²ç»èƒ½å¤Ÿå°† JSON æ˜ å°„åˆ° ABAP é‡Œï¼Œä¸‹é¢æˆ‘ä»¬è¯•ç€å°† ABAP å†è½¬å› JSONã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ <code>call transformation</code> ä¸­çš„ <code>source</code> å’Œ <code>result</code> å¯¹è°ƒï¼Œåå‘ä½¿ç”¨â€œè½¬æ¢â€ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">CALL TRANSFORMATION</span> z_test_json1 <span style="color:#66d9ef">SOURCE </span>out <span style="color:#f92672">=</span> it_result
                                 <span style="color:#66d9ef">RESULT XML</span> <span style="color:#f92672">=</span> v_text.
</code></pre></div><p><strong>v_text</strong> :</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-16&quot;?&gt;
&lt;array&gt;
  &lt;object&gt;
    &lt;str name=&quot;result&quot;&gt;0.01&lt;/str&gt;
    &lt;str name=&quot;errorCode&quot;&gt;0&lt;/str&gt;
    &lt;str name=&quot;errorMessage&quot;&gt; &lt;/str&gt;
  &lt;/object&gt;
  &lt;object&gt;
    &lt;str name=&quot;result&quot;&gt;2.01&lt;/str&gt;
    &lt;str name=&quot;errorCode&quot;&gt;0&lt;/str&gt;
    &lt;str name=&quot;errorMessage&quot;&gt; &lt;/str&gt;
  &lt;/object&gt;
&lt;/array&gt;
</code></pre><p>æˆ‘ä»¬å‘ç° <code>v_text</code> é‡Œçš„æ˜¯ XMLï¼Œå¦‚æœéœ€è¦çš„æ˜¯ XML æ ¼å¼ï¼Œé‚£ä¹ˆä»»åŠ¡å·²ç»å®Œæˆã€‚ä¸ºäº†å¾—åˆ° JSONï¼Œæˆ‘ä»¬ç»§ç»­åšå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<pre><code>DATA json_writer TYPE REF TO cl_sxml_string_writer.
json_writer = cl_sxml_string_writer=&gt;create( type = if_sxml=&gt;co_xt_json ).
CALL TRANSFORMATION z_test_json1 SOURCE out = it_result
                                 RESULT XML json_writer. &quot; json_writer.

&quot; Get json-String from writer
DATA json TYPE xstring.
json = json_writer-&gt;get_output( ).
v_text = cl_ABAP_codepage=&gt;convert_from( json ).
</code></pre><p>æˆ‘ä»¬ç”¨ç±»å‹ä¸º co_xt_json çš„ sxml_string_writerï¼Œå°† XML è¾“å‡ºä¸º JSON æ ¼å¼ã€‚ <strong>æ³¨æ„</strong> <code>get_output()</code> è¾“å‡ºçš„æ˜¯å­—èŠ‚ç ï¼Œè¦ç”¨ <code>cl_abap_codepage=&gt;convert_from( )</code> è½¬æ¢æˆæ–‡æœ¬ã€‚</p>
<p><strong>v_text</strong> :</p>
<pre><code>[
  {
    &quot;result&quot;:0.01,
    &quot;errorCode&quot;:&quot;0&quot;,
    &quot;errorMessage&quot;:&quot;&quot;
    },
  {
    &quot;result&quot;:2.01,
    &quot;errorCode&quot;:&quot;0&quot;,
    &quot;errorMessage&quot;:&quot;&quot;
  }
]
</code></pre><p>- åç¯‡ <a href="post/abap_provide_restful_ws/">&ldquo;ABAP å‘å¸ƒ RESTful Web Service&rdquo;</a></p>

 <p>ã€ çµ‚ ã€</p>

    </article>
</section>

<footer class="bottom-footer">
  
</footer>

<script>
  renderMathInElement(document.getElementById('main'));
</script>

</div>


<a href="javascript:" id="return-to-top"><i class="icon-chevron-up"></i></a>

<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

</body>

</html>
