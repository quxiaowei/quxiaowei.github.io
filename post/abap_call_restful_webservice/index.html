<!DOCTYPE html>
<html class="no-js" lang="en-US">
    <head>
        <meta charset="utf-8">

        

        <base href="https://quxiaowei.github.io">
		<title>&ltquxiaowei/&gt</title>
        <link rel="canonical" href="https://quxiaowei.github.io/post/abap_call_restful_webservice/">
        <link href="" rel="alternate" type="application/rss+xml" title="&lt;/&gt;"/>

        
<link rel="stylesheet" href="https://quxiaowei.github.io/css/styles.css">

<link rel="stylesheet" type="text/css" href='https://fonts.googleapis.com/css?family=Roboto+Mono'>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://quxiaowei.github.io/css/dracula.css">
<script src="https://quxiaowei.github.io/script/highlight.pack.js"></script>
<script src="https://quxiaowei.github.io/script/abap.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
        <div class="column">

<header class="header">
    <a href="/" class="title">&lt;/&gt;</a>
    
</header>


<section id="main">
    <header class="post-header">
      <p class="post-title"><a href="https://quxiaowei.github.io/post/abap_call_restful_webservice/">ABAP 调用 RESTful Web Service </a></p>
      <p class="post-meta">2016.7.19</p>
    </header>
    <article itemprop="articleBody" id="content">
       

<hr />

<h2 id="关于rest">关于REST</h2>

<p>REST 是基于 http 的 web service 架构，URL表示资源，http method: GET, POST, DELETE 等等，表示发送，收取，删除动作。我们是从第三方接收资源，用 GET 就可以了。</p>

<blockquote>
<p>SOAP 是另一种基于 http 的 web service 协议，不在本文范围内。</p>
</blockquote>

<p>以<code>http://example/credit/20160516/0000001880/1380</code>为例，其中<code>20160516</code>代表日期，<code>0000001880</code>代表客户，<code>1380</code>代表公司，这些是 web service 的参数，要与发布者协商好格式。</p>

<hr />

<h2 id="http调用">http调用</h2>

<p>abap 有许多发送 http GET 请求的方法。我用的是函数: <code>HTTP_GET</code>。注意设定超时限制，防止网络不通时程序卡死。</p>

<pre><code class="language-abap">DATA: status(3) TYPE c ,
      url TYPE c LENGTH 200,
      error TYPE string.
        
DATA: response TYPE TABLE OF xtext100 WITH HEADER LINE, &quot; 返回内容
      &quot; http header
      response_headers TYPE TABLE OF text100 WITH HEADER LINE. 
        
url = |http://example/credit/{ p_datum }/{ p_customer }/{ p_company }| .

CALL FUNCTION 'HTTP_GET'
  EXPORTING
    absolute_uri          = url    &quot; url
    timeout               = 1      &quot; 超时
  IMPORTING
    status_code           = status  &quot; 200 404等网页状态
  TABLES
    response_entity_body  = response
    response_headers      = response_headers
  EXCEPTIONS
    connect_failed        = 1
    timeout               = 2
    internal_error        = 3
    tcpip_error           = 4
    data_error            = 5
    system_failure        = 6
    communication_failure = 7
    OTHERS                = 8.

IF sy-subrc EQ 0 AND status(1) EQ '2'.
  &quot; 成功
ELSE.
  &quot; 失败
ENDIF.
</code></pre>

<hr />

<h2 id="decode">Decode</h2>

<p>返回内容的编码可能与 sap 不兼容，那么需要转码。具体编码信息在 http 头里。</p>

<p>以常见的 UTF-8 为例*Decode 代码*：</p>

<pre><code class="language-abap">DATA conv TYPE REF TO cl_abap_conv_in_ce.
DATA buffer TYPE xstring.
DATA v_text TYPE string.&quot;(100) TYPE c.
DATA v_text_t TYPE string.&quot;(100) TYPE c.
  
conv = cl_abap_conv_in_ce=&gt;create( encoding = 'UTF-8' ).
LOOP AT response.
  buffer = response.
  TRY.
      conv-&gt;convert(
            EXPORTING input = buffer
            IMPORTING data = v_text_t ).
      CONCATENATE v_text v_text_t INTO v_text.
    CATCH cx_sy_conversion_codepage 
          cx_sy_codepage_converter_init 
          cx_parameter_invalid_type.
      p_subrc = 4.
      p_message = '转码失败！'.
      RETURN.
  ENDTRY.
ENDLOOP.
</code></pre>

<hr />

<h2 id="json映射到abap">json映射到ABAP</h2>

<p>Web Service 常见的返回内容格式有 xml 和 json 两种。xml 的处理方法和 json 大致相同，只是 “转换”的写法不同。以 json 为例：</p>

<p><em>json 示例</em></p>

<pre><code class="language-js">[
  {
    &quot;result&quot;:0.0122,
    &quot;errorCode&quot;:&quot;0&quot;,
    &quot;errorMessage&quot;:&quot;&quot;
    }, 
  {
    &quot;result&quot;:2.01,
    &quot;errorCode&quot;:&quot;0&quot;,
    &quot;errorMessage&quot;:&quot;&quot;
  }
]
</code></pre>

<p>这是一个包含2个对象的数组（<code>[]</code>表示数组），每个对象（<code>{}</code>表示对象）中有三个字段： <code>result</code>, <code>errorCode</code>, <code>errorMessage</code>。<code>result</code>是数字型的（注意没有引号包围），其他均为字符串。</p>

<p><em>abap 代码</em></p>

<pre><code class="language-abap">TYPES: BEGIN OF ty_result,
        result TYPE string,
        errorcode TYPE string,
        errormessage TYPE string,
       END OF ty_result.
DATA it_result TYPE TABLE OF ty_result.

TRY
    CALL TRANSFORMATION z_test_json1 SOURCE XML v_text
                                     RESULT out = it_result.
  CATCH cx_st_error cx_xslt_exception cx_transformation_error.
    &quot; 解析json失败
ENDTRY.
</code></pre>

<p><code>z_test_json1</code> 是自定义的 “转换”，将 json 中的数据映射到 abap 内表或工作区里，因为过程涉及类型转换，所以需要 <code>try catch</code> 来捕捉异常。“转换”完成后，json 中的数据回填到 <code>it_result</code>内表中，整个流程也就完成了。</p>

<hr />

<h2 id="转换-的写法">“转换”的写法</h2>

<ol>
<li><p>创建“转换” <img src="/img/transform1.png" alt="创建“转换”" /></p></li>

<li><p>转换类型选择“简单转换”</p></li>

<li><p>“转换”示例</p></li>
</ol>

<pre><code class="language-XML">&lt;?sap.transform simple?&gt;
&lt;tt:transform xmlns:tt=&quot;http://www.sap.com/transformation-templates&quot;&gt;
  &lt;tt:root name=&quot;OUT&quot;/&gt;
  &lt;tt:template&gt;
    &lt;array&gt;
      &lt;tt:loop ref=&quot;.RESULT&quot;&gt;
        &lt;object&gt;
          &lt;num name=&quot;result&quot;&gt;
            &lt;tt:value ref=&quot;$ref.RESULT&quot;/&gt;
          &lt;/num&gt;
          &lt;str name=&quot;errorCode&quot;&gt;
            &lt;tt:value ref=&quot;$ref.ERRORCODE&quot;/&gt;
          &lt;/str&gt;
          &lt;str name=&quot;errorMessage&quot;&gt;
            &lt;tt:value ref=&quot;$ref.ERRORMESSAGE&quot;/&gt;
          &lt;/str&gt;
        &lt;/object&gt;
      &lt;/tt:loop&gt;
    &lt;/array&gt;
  &lt;/tt:template&gt;
&lt;/tt:transform&gt;
</code></pre>

<ul>
<li><p><code>&lt;array&gt;</code> 代表数组，与 json 的 <code>[]</code>对应</p></li>

<li><p><code>&lt;object&gt;</code> 代表对象，与 json 的 <code>{}</code>对应</p></li>

<li><p><code>&lt;tt:loop&gt;</code> 循环处理多个对象，“转换” 把数据依次 append 到内表中，对于单条数据不需要使用<code>&lt;tt:loop&gt;</code></p></li>

<li><p><code>&lt;num&gt;</code> <code>&lt;str&gt;</code> 代表数字、字符串，这里的类型要与 json 对应，否则会报错，如果有非法字符会报异常，所以转换过程需要用<code>try catch</code>来捕捉异常</p></li>

<li><p><code>&lt;tt:value&gt;</code> <code>name</code> 属性与表字段名对应，转换程序会自动将值放到内表或工作区的字段中。</p></li>

<li><p><code>&lt;tt:root&gt;</code> <code>name</code> 为“转换”结果（RESULT）的形参名（本例为 out）</p></li>
</ul>

<blockquote>
<p>json 对象内的字段不要求和 abap 类型字段顺序一致</p>
</blockquote>

<hr />

<p>我们已经能够将 json 映射到 abap 里，下面我们试着将 abap 再转回 json。</p>

<p>首先，我们将上面的 <code>call transformation</code> 中的 <code>source</code> 和 <code>result</code> 对调。</p>

<pre><code>CALL TRANSFORMATION z_test_json1 SOURCE out = it_result
                                 RESULT XML = v_text.
</code></pre>

<p><strong>v_text</strong></p>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-16&quot;?&gt;&lt;array&gt;&lt;object&gt;&lt;str name=&quot;result&quot;&gt;-282.414352&lt;/str&gt;&lt;str name=&quot;errorCode&quot;&gt;0&lt;/str&gt;&lt;str name=&quot;errorMessage&quot;&gt; &lt;/str&gt;&lt;/object&gt;&lt;/array&gt;
</code></pre>

<p>我们发现 <code>v_text</code> 里的是 XML，如果需要的是 XML 格式，那么任务已经完成。</p>

<p>为了得到 json，我们做如下修改：</p>

<pre><code>DATA json_writer TYPE REF TO cl_sxml_string_writer.
json_writer = cl_sxml_string_writer=&gt;create( type = if_sxml=&gt;co_xt_json ).
CALL TRANSFORMATION z_test_json1 SOURCE out = it_result
                                 RESULT XML json_writer. &quot; json_writer.

&quot; Get JSON-String from writer
DATA json TYPE xstring.
json = json_writer-&gt;get_output( ).
v_text = cl_abap_codepage=&gt;convert_from( json ).
</code></pre>

<p>我们用类型为 co_xt_json 的 sxml_string_writer，将 xml 输出为 json 格式。 <strong>注意</strong> <code>get_output()</code> 输出的是字节码，要用 <code>cl_abap_codepage=&gt;convert_from( )</code> 转换成文本。</p>

<pre><code class="language-js">[{&quot;result&quot;:0.0122,&quot;errorCode&quot;:&quot;0&quot;,&quot;errorMessage&quot;:&quot; &quot;}]
</code></pre>

<p>『 終 』</p>
    </article>
</section>

<footer class="bottom-footer">
  <div class="copyright">
    <p>
    
    <a href="http://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution">Some rights reserved</a>; 
    please attribute properly and link back.
    
    
    </p>
  </div>
</footer>

<script>
    renderMathInElement(document.getElementById('main'));
</script>

</div>
</body>
</html>

