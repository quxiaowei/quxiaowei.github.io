<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    <base href="https://quxiaowei.github.io">
    <title>A CodeSmith</title>
    <link rel="canonical" href="https://quxiaowei.github.io/post/python_no_nested_anymore/">
    
<link rel="stylesheet" href="https://quxiaowei.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="https://quxiaowei.github.io/css/styles.css">
<link rel="stylesheet" href="https://quxiaowei.github.io/css/post.css">


<link href="https://quxiaowei.github.io/index.xml" rel="alternate" type="application/rss+xml" title="A CodeSmith" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="./script/site.js"></script>
</head>

<body>
    <div class="column container">
<header class="header">
    <a href="/" class="title">A CodeSmith</a>
    
</header>


<section id="main" class="col-md-10">
    <header class="post-header">
      <p class="post-title">Python 的 nested() 不见了 </p>
      <p class="post-meta">2016年7月14日</p>
    </header>
    <article itemprop="articleBody" id="content">
       <p>最近在和别的系统测试 Rest Web Service 的接口，用 python 写了单元测试脚本 <a href="https://gist.github.com/quxiaowei/5440de7c9e2e9b835e5b6225b040a491">(Gist)</a>。却发现<code>nested</code>不见了，查了替代方案记下。</p>
<p><code>with</code> 写法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;D:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">input.txt&#39;</span>) <span style="color:#66d9ef">as</span> file1:
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;D:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">output.txt&#39;</span> <span style="color:#e6db74">&#39;w+&#39;</span>) <span style="color:#66d9ef">as</span> file2:
        <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> file1<span style="color:#f92672">.</span>readline():
            file2<span style="color:#f92672">.</span>write(line<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p><code>nested()</code> 写法（<code>caveat</code>: 已经不可用了）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> nested

<span style="color:#66d9ef">with</span> (open(<span style="color:#e6db74">&#39;D:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">input.txt&#39;</span>), open(<span style="color:#e6db74">&#39;D:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">output.txt&#39;</span>, <span style="color:#e6db74">&#39;w+&#39;</span>)) \
    <span style="color:#66d9ef">as</span> (file1, file2):
    
    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> file1<span style="color:#f92672">.</span>readline():
        file2<span style="color:#f92672">.</span>write(line<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>新写法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> ExitStack

<span style="color:#66d9ef">with</span> ExitStack() <span style="color:#66d9ef">as</span> stack:
    file1 <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span>enter_context(open(<span style="color:#e6db74">&#39;D:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">input.txt&#39;</span>))
    file2 <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span>enter_context(open(<span style="color:#e6db74">&#39;D:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">output.txt&#39;</span>, <span style="color:#e6db74">&#39;w+&#39;</span>))
    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> file1<span style="color:#f92672">.</span>readline():
        file2<span style="color:#f92672">.</span>write(line<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>其实对于一两个资源来说，直接用 nested-with 的语法写起来还行，用 ExitStack 看起来就有点啰嗦了。对于多个资源来说，用<code>ExitStack</code> + <code>list comprehence</code>写起来倒也不麻烦。</p>

 <p>『 終 』</p>

    </article>
</section>

<footer class="bottom-footer">
  
</footer>

<script>
  renderMathInElement(document.getElementById('main'));
</script>

</div>


<a href="javascript:" id="return-to-top"><i class="icon-chevron-up"></i></a>

<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

</body>

</html>
